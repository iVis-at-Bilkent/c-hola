<!DOCTYPE>

<html>

	<head>
		<title>cytoscape-view-utilities.js demo</title>

		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">

        <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
		<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

		<!-- for testing with local version of cytoscape.js -->
		<!--<script src="../cytoscape.js/build/cytoscape.js"></script>-->
        <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/2.0.4/cytoscape-cose-bilkent.js"></script>
        <script src="lib/cytoscape-undo-redo.js"></script>


		<script src="cytoscape-view-utilities.js"></script>

		<style>
			body {
				font-family: helvetica neue, helvetica, liberation sans, arial, sans-serif;
				font-size: 14px;
			}

			#cy {
				z-index: 999;
                width: 85%;
                height: 85%;
                float: left;
			}

			h1 {
				opacity: 0.5;
				font-size: 1em;
				font-weight: bold;
			}
		</style>

		<script>

			document.addEventListener("DOMContentLoaded", function(){

                var cy = window.cy = cytoscape({
                    container: document.getElementById('cy'),
                    layout: { name: "cose-bilkent" },
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'content': 'data(name)',
                                'border-color': '#ff0000'
                            }
                        },

                        {
                            selector: 'edge',
                            style: {
                                'target-arrow-shape': 'triangle'
                            }
                        },

                        {
                            selector: ':selected',
                            style: {

                            }
                        }
                    ],

                    elements: {
                        nodes: [
                            { data: { id: 'n1', name: 'n1' }, style: {'border-color': '#aabbcc'} },
                            { data: { id: 'n2', name: 'n2', parent: "n1"} },
                            { data: { id: 'n3', name: 'n3', parent: "n1" } },
                            { data: { id: 'n4', name: 'n4', parent: "n1" } },
                            { data: { id: 'n5', name: 'n5' } },
                            { data: { id: 'n6', name: 'n6' } },
                            { data: { id: 'n7', name: 'n7' } },
                            { data: { id: 'n8', name: 'n8' } },
                            { data: { id: 'n9', name: 'n9' } },
                            { data: { id: 'n10', name: 'n10' } },
                            { data: { id: 'n11', name: 'n11' } },
                            { data: { id: 'n12', name: 'n12' } },
                            { data: { id: 'n13', name: 'n13' } },
                            { data: { id: 'n14', name: 'n14' } },
                            { data: { id: 'n15', name: 'n15' } },
                            { data: { id: 'n16', name: 'n16' } },
                            { data: { id: 'n17', name: 'n17' } },
                            { data: { id: 'n18', name: 'n18' } },
                            { data: { id: 'n19', name: 'n19' } }, 
                            { data: { id: 'n20', name: 'n20' } },
                            { data: { id: 'n21', name: 'n21' } },                                                         
                        ],
                        edges: [
                            { data: { source: 'n2', target: 'n3' } },
                            { data: { source: 'n4', target: 'n3' } },
                            { data: { source: "n3", target: "n5" } },
                            { data: { source: "n5", target: "n6" } },
                            { data: { source: 'n5', target: 'n7' } },
                            { data: { source: 'n6', target: 'n7' } },
                            { data: { source: "n7", target: "n8" } },
                            { data: { source: "n8", target: "n9" } },   
                            { data: { source: 'n7', target: 'n10' } },
                            { data: { source: 'n6', target: 'n11' } },
                            { data: { source: "n7", target: "n11" } },
                            { data: { source: "n9", target: "n10" } },
                            { data: { source: 'n10', target: 'n11' } },
                            { data: { source: 'n10', target: 'n12' } },
                            { data: { source: "n12", target: "n13" } },
                            { data: { source: "n12", target: "n14" } },  
                            { data: { source: "n12", target: "n15" } },
                            { data: { source: "n13", target: "n15" } },   
                            { data: { source: 'n15', target: 'n16' } },
                            { data: { source: 'n15', target: 'n17' } },
                            { data: { source: "n15", target: "n18" } },
                            { data: { source: "n17", target: "n19" } },
                            { data: { source: 'n17', target: 'n20' } },
                            { data: { source: 'n19', target: 'n20' } },
                            { data: { source: "n19", target: "n21" } }                           
                        ]
                    }
                });

                var api = cy.viewUtilities({
                    neighbor: function(node){
                        return node.closedNeighborhood();
                    },
                    neighborSelectTime: 1000
                });
                
                var ur = cy.undoRedo();
                
                // Increase border width to show nodes with hidden neighbors
                function thickenBorder(eles){
                  eles.forEach(function( ele ){
                    var defaultBorderWidth = Number(ele.css("border-width").substring(0,ele.css("border-width").length-2));
                    ele.css("border-width", defaultBorderWidth + 2);
                  });
                  eles.data("thickBorder", true);
                  return eles;
                }
                // Decrease border width when hidden neighbors of the nodes become visible
                function thinBorder(eles){
                  eles.forEach(function( ele ){
                    var defaultBorderWidth = Number(ele.css("border-width").substring(0,ele.css("border-width").length-2));
                    ele.css("border-width", defaultBorderWidth - 2);
                  });
                  eles.removeData("thickBorder");
                  return eles;
                }
                
                ur.action("thickenBorder", thickenBorder, thinBorder);
                ur.action("thinBorder", thinBorder, thickenBorder);
                
                //In below functions, finding the nodes to hide/show are sample specific. 
                //If the sample graph changes, those calculations may also need a change.   
                
                $("#hide").click(function (){
                    var actions = [];                    
                    var nodesToHide = cy.$(":selected").add(cy.$(":selected").nodes().descendants());                  
                    var nodesWithHiddenNeighbor = cy.edges(":hidden").connectedNodes().intersection(nodesToHide);
                    actions.push({name: "thinBorder", param: nodesWithHiddenNeighbor});
                    actions.push({name: "hide", param: nodesToHide});                    
                    nodesWithHiddenNeighbor = nodesToHide.neighborhood(":visible")
                        .nodes().difference(nodesToHide).difference(cy.nodes("[thickBorder]"));
                    actions.push({name: "thickenBorder", param: nodesWithHiddenNeighbor}); 
                    cy.undoRedo().do("batch", actions);
                });

                $("#showAll").click(function () {
                    var actions = [];
                    var nodesWithHiddenNeighbor = cy.nodes("[thickBorder]");
                    actions.push({name: "thinBorder", param: nodesWithHiddenNeighbor});
                    actions.push({name: "show", param: cy.elements()});
                    ur.do("batch", actions);                    
                });
                
                $("#showHiddenNeighbors").click(function () {
                    var hiddenEles = cy.$(":selected").neighborhood().filter(':hidden');
                    var actions = [];
                    var nodesWithHiddenNeighbor = (hiddenEles.neighborhood(":visible").nodes("[thickBorder]"))
                        .difference(cy.edges(":hidden").difference(hiddenEles.edges().union(hiddenEles.nodes().connectedEdges())).connectedNodes());
                    actions.push({name: "thinBorder", param: nodesWithHiddenNeighbor});
                    actions.push({name: "show", param: hiddenEles.union(hiddenEles.parent())});
                    nodesWithHiddenNeighbor = hiddenEles.nodes().edgesWith(cy.nodes(":hidden").difference(hiddenEles.nodes()))
                        .connectedNodes().intersection(hiddenEles.nodes());
                    actions.push({name: "thickenBorder", param: nodesWithHiddenNeighbor}); 
                    cy.undoRedo().do("batch", actions);                
                });
                
                var tappedBefore;

                cy.on('tap', 'node', function (event) {
                  var node = this;

                  var tappedNow = node;
                  setTimeout(function () {
                    tappedBefore = null;
                  }, 300);
                  if (tappedBefore && tappedBefore.id() === tappedNow.id()) {
                    tappedNow.trigger('doubleTap');
                    tappedBefore = null;
                  } else {
                    tappedBefore = tappedNow;
                  }
                });
                
                cy.on('doubleTap', 'node', function (event) {
                    var hiddenEles = cy.$(":selected").neighborhood().filter(':hidden');
                    var actions = [];
                    var nodesWithHiddenNeighbor = (hiddenEles.neighborhood(":visible").nodes("[thickBorder]"))
                        .difference(cy.edges(":hidden").difference(hiddenEles.edges().union(hiddenEles.nodes().connectedEdges())).connectedNodes());
                    actions.push({name: "thinBorder", param: nodesWithHiddenNeighbor});
                    actions.push({name: "show", param: hiddenEles.union(hiddenEles.parent())});
                    nodesWithHiddenNeighbor = hiddenEles.nodes().edgesWith(cy.nodes(":hidden").difference(hiddenEles.nodes()))
                        .connectedNodes().intersection(hiddenEles.nodes());
                    actions.push({name: "thickenBorder", param: nodesWithHiddenNeighbor}); 
                    cy.undoRedo().do("batch", actions);
                });

                $("#highlightNeighbors").click(function () {
                    if(cy.$(":selected").length > 0)
                        ur.do("highlightNeighbors", cy.$(":selected"));
                });

                $("#removeHighlights").click(function () {
                    ur.do("removeHighlights");
                });

                $("#search").click(function () {
                    var text = $("#toSearch").val();
                    cy.elements().search(text).highlightNeighbors();
                });
                
                document.addEventListener("keydown", function (e) {
                    if (e.ctrlKey){
                        if (e.which === 90)
                            ur.undo();
                        else if (e.which === 89)
                            ur.redo();
                    }
                });
			});
		</script>
	</head>

	<body>
		<h1>cytoscape.js-view-utilities demo</h1>

        <b>CTRL+Z</b> to undo, <b>CTRL+Y</b> to redo<br/>

        <b id="hide" style="cursor: pointer; color: darksalmon">Hide Selected</b> / <b id="showAll" style="cursor: pointer; color: darkmagenta">Show All</b> <br/>
        <b id="showHiddenNeighbors" style="cursor: pointer; color: darksalmon">Show Hidden Neighbors of Selected</b> <br/>
        <b id="highlightNeighbors" style="cursor: pointer; color: darksalmon">Highlight Neighbors</b> / <b id="removeHighlights" style="cursor: pointer; color: darkmagenta">Remove Highlights</b> <br/>
        <b>SHIFT + taphold</b> to select neighbors<br/>    

        <div id="cy"></div>

	</body>

</html>
